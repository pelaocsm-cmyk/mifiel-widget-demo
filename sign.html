<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tenaris — Firma (Sandbox)</title>
  <!-- SANDBOX: para producción cambia a https://app.mifiel.com/widget-component/index.js -->
  <script src="https://app-sandbox.mifiel.com/widget-component/index.js" defer crossorigin="anonymous"></script>
  <style>
    :root{color-scheme:light dark}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto;background:#0b1220;color:#fff}
    header{padding:20px 16px;text-align:center}
    h1{font-size:1.25rem;margin:0}
    main{max-width:1100px;margin:0 auto;padding:16px}
    .card{background:#0f172a;border-radius:14px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .viewport{position:relative;background:#0a1020;border-radius:14px;min-height:560px;height:72vh;overflow:hidden}
    mifiel-widget{display:block;width:100%;height:72vh;min-height:560px}
    .row{display:flex;gap:10px;margin-top:12px}
    .btn{padding:10px 12px;border-radius:10px;border:1px solid #2b3a54;background:#1f2744;color:#fff;cursor:pointer;text-decoration:none}
    .btn.primary{background:#22c55e;color:#06121e;border:none;font-weight:700}
    .muted{opacity:.8}
    .loading{position:absolute;inset:0;display:grid;place-items:center;background:rgba(2,6,23,.35);backdrop-filter:blur(2px);font-weight:600;letter-spacing:.2px}
    pre{white-space:pre-wrap;background:#0b1324;border:1px solid #27324a;padding:10px;border-radius:10px;max-height:250px;overflow:auto}
  </style>
</head>
<body>
  <header>
    <h1>Firma de documento — Tenaris</h1>
    <p class="muted">Vista móvil/desktop • e.firma (.cer/.key/contraseña) • Al final: PDF con QR + XML</p>
  </header>

  <main class="card">
    <div id="vp" class="viewport">
      <div id="ld" class="loading">Cargando documento…</div>
      <!-- aquí se montará el widget -->
    </div>
    <p class="muted" id="status">Preparando widget…</p>
    <div id="result"></div>
  </main>

  <script>
    // --- Parámetros y defaults ---
    const DEFAULT_ID  = 'kn4PBSwMk1';        // <- tu widgetId de sandbox
    const DEFAULT_ENV = 'sandbox';            // sandbox | production

    const q      = new URLSearchParams(location.search);
    const id     = q.get('id')  || DEFAULT_ID;
    const env    = q.get('env') || DEFAULT_ENV;

    const vp     = document.getElementById('vp');
    const ld     = document.getElementById('ld');
    const status = document.getElementById('status');
    const result = document.getElementById('result');

    function hideLoader(){ if(ld) ld.style.display = 'none'; }

    // Monta el widget (crea un elemento nuevo cada vez)
    async function mount(){
      if(!id){ alert('Falta widgetId (?id=...)'); return; }

      // Espera a que el custom element exista
      if (window.customElements?.whenDefined) {
        try { await customElements.whenDefined('mifiel-widget'); } catch {}
      }

      // Limpia widgets anteriores
      vp.querySelectorAll('mifiel-widget').forEach(n => n.remove());

      // Crea componente mínimo (id + environment)
      const widget = document.createElement('mifiel-widget');
      widget.setAttribute('id', id);
      widget.setAttribute('environment', env);

      // Eventos del widget
      widget.addEventListener('signSuccess', (ev) => {
        hideLoader();
        const payload = ev?.detail || {};
        const pretty  = JSON.stringify(payload, null, 2);

        // Enlaces: conecta a tus URLs si las tienes; si no, quedan como placeholders
        const pdfUrl = '#'; // <- reemplaza por URL al PDF firmado (con QR) si tu backend la expone
        const xmlUrl = '#'; // <- reemplaza por URL al XML/verificador

        result.innerHTML = `
          <div class="row" style="margin-top:12px">
            <a class="btn primary" href="${pdfUrl}" onclick="if(this.href.endsWith('#')){alert('Conecta aquí la URL del PDF firmado con QR');return false;}" target="_blank" rel="noopener">Descargar PDF con QR</a>
            <a class="btn" href="${xmlUrl}" onclick="if(this.href.endsWith('#')){alert('Conecta aquí la URL del XML/verificador');return false;}" target="_blank" rel="noopener">Ver XML / Verificador</a>
          </div>
          <details style="margin-top:12px"><summary class="muted">Payload del evento</summary>
            <pre>${pretty}</pre>
          </details>
        `;
        status.textContent = '¡Firma completada!';
      });

      widget.addEventListener('signError', (err) => {
        hideLoader();
        status.textContent = 'Error durante la firma';
        result.innerHTML = `<pre>${(err && err.message) ? err.message : (err || '')}</pre>`;
        console.error('[Mifiel] signError', err);
      });

      // Monta y actualiza estado
      vp.appendChild(widget);
      status.textContent = `Firmante cargado: ${id} (${env})`;

      // Fallback para ocultar el loader si el componente tarda en emitir eventos
      setTimeout(hideLoader, 2500);
    }

    mount();
  </script>
</body>
</html>
