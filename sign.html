<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ejemplo Widget Mifiel â€” Sandbox</title>

  <!-- âœ” SANDBOX. Para producciÃ³n usa: https://app.mifiel.com/widget-component/index.js -->
  <script src="https://app-sandbox.mifiel.com/widget-component/index.js" defer crossorigin="anonymous"></script>

  <style>
    :root{ color-scheme: light dark }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto; background:#0b1220; color:#fff }
    header{ padding:20px 16px; text-align:center }
    h1{ font-size:1.25rem; margin:0 }
    main{ max-width:1100px; margin:0 auto; padding:16px }
    .card{ background:#0f172a; border-radius:14px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.35) }
    /* ðŸ‘‡ el widget usa esta clase para fijar el tamaÃ±o del iframe */
    .widget-container{ height:72vh; min-height:560px; border-radius:14px; overflow:hidden; background:#0a1020 }
    .row{ display:flex; gap:10px; margin-top:12px }
    .btn{ padding:10px 12px; border-radius:10px; border:1px solid #2b3a54; background:#1f2744; color:#fff; text-decoration:none }
    .btn.primary{ background:#22c55e; color:#06121e; border:none; font-weight:700 }
    .muted{ opacity:.8 }
    pre{ white-space:pre-wrap; background:#0b1324; border:1px solid #27324a; padding:10px; border-radius:10px; max-height:260px; overflow:auto }
  </style>
</head>
<body>
  <header>
    <h1>Firmar Documento â€” Mifiel (Sandbox)</h1>
    <p class="muted">Soporta deep-link: <code>?id=&lt;WIDGET_ID&gt;&env=sandbox|production</code></p>
  </header>

  <main class="card">
    <!-- ðŸ§© Widget -->
    <mifiel-widget
      id="kn4PBSwMk1"              <!-- â† widgetId por defecto -->
      environment="sandbox"        <!-- â† cambia a 'production' al ir a vivo -->
      success-btn-text="Continuar al siguiente paso"
      success-btn-action="#"
      error-btn-action="#"
      container-class="widget-container"
    ></mifiel-widget>

    <p id="status" class="muted" style="margin-top:10px">Listo para firmarâ€¦</p>
    <div id="result"></div>
  </main>

  <script>
    // Permite override por URL (?id=...&env=sandbox|production)
    const p   = new URLSearchParams(location.search);
    const wid = p.get('id')  || 'kn4PBSwMk1';
    const env = p.get('env') || 'sandbox';

    document.addEventListener('DOMContentLoaded', () => {
      const w = document.querySelector('mifiel-widget');
      w.setAttribute('id', wid);
      w.setAttribute('environment', env);

      const status = document.getElementById('status');
      const result = document.getElementById('result');
      status.textContent = `Firmante cargado: ${wid} (${env})`;

      function onSuccessHandler(ev){
        const payload = ev?.detail || {};
        const pretty  = JSON.stringify(payload, null, 2);

        // ðŸ”— Conecta estas URLs si tu backend expone enlaces directos al PDF/XML:
        const pdfUrl = '#';
        const xmlUrl = '#';

        status.textContent = 'Â¡Firma completada!';
        result.innerHTML = `
          <div class="row">
            <a class="btn primary" href="${pdfUrl}"
               onclick="if(this.href.endsWith('#')){alert('Conecta aquÃ­ la URL del PDF firmado con QR');return false;}"
               target="_blank" rel="noopener">Descargar PDF con QR</a>
            <a class="btn" href="${xmlUrl}"
               onclick="if(this.href.endsWith('#')){alert('Conecta aquÃ­ la URL del XML / verificador');return false;}"
               target="_blank" rel="noopener">Ver XML / Verificador</a>
          </div>
          <details style="margin-top:12px"><summary class="muted">Payload del evento</summary>
            <pre>${pretty}</pre>
          </details>
        `;
        console.log('Documento firmado (payload):', payload);
      }

      function onErrorHandler(err){
        status.textContent = 'Error durante la firma';
        result.innerHTML = `<pre>${(err && err.message) ? err.message : (err || '')}</pre>`;
        console.error('Error de firma:', err);
      }

      // âœ… Eventos correctos del componente
      w.addEventListener('signSuccess', onSuccessHandler);
      w.addEventListener('signError', onErrorHandler);
    });
  </script>
</body>
</html>
